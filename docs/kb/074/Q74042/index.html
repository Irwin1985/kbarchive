<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/kbarchive/assets/css/style.css?v=d2057ae472d963fbdcbf65805f43123bccb709dc">
    <link rel="stylesheet" type="text/css" href="/kbarchive/assets/css/print.css" media="print">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Q74042: HOWTO: How to Use PeekMessage() Correctly in Windows | KnowledgeBase Archive</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Q74042: HOWTO: How to Use PeekMessage() Correctly in Windows" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="An Archive of Early Microsoft KnowledgeBase Articles" />
<meta property="og:description" content="An Archive of Early Microsoft KnowledgeBase Articles" />
<link rel="canonical" href="http://jeffpar.github.io/kbarchive/kb/074/Q74042/" />
<meta property="og:url" content="http://jeffpar.github.io/kbarchive/kb/074/Q74042/" />
<meta property="og:site_name" content="KnowledgeBase Archive" />
<script type="application/ld+json">
{"headline":"Q74042: HOWTO: How to Use PeekMessage() Correctly in Windows","url":"http://jeffpar.github.io/kbarchive/kb/074/Q74042/","description":"An Archive of Early Microsoft KnowledgeBase Articles","@type":"WebPage","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>

<body>
<div id="container">
    <div class="inner">

        <header>
            <h1><a href="/kbarchive">KnowledgeBase Archive</a></h1>
            <h2>An Archive of Early Microsoft KnowledgeBase Articles</h2>
        </header>
        <section id="downloads" class="clearfix">
            
            
            <a href="https://github.com/jeffpar/kbarchive" id="view-on-github" class="button"><span>View on GitHub</span></a>
            
        </section>
        <hr>
        <section id="main_content">
                <div>
        <h2 id="q74042-howto-how-to-use-peekmessage-correctly-in-windows">Q74042: HOWTO: How to Use PeekMessage() Correctly in Windows</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Article: Q74042
Product(s): Microsoft Windows Software Development Kit
Version(s): WINDOWS:3.1,4.0,95; winnt:3.5,3.51
Operating System(s): 
Keyword(s): kb16bitonly kbSDKPlatform kbWndw kbWndwMsg
Last Modified: 11-MAY-2001

3.00 3.10 4.00 | 3.10 3.50 3.51
WINDOWS        | WINDOWS NT
kbui


-------------------------------------------------------------------------------
The information in this article applies to:

- Microsoft Windows Software Development Kit (SDK) 3.1 
- Microsoft Win32 Application Programming Interface (API), used with:
   - Microsoft Windows 4.0 
-------------------------------------------------------------------------------

SUMMARY
=======

In the Windows environment, many applications use a PeekMessage() loop to
perform background processing. Such applications must allow the Windows system
to enter an idle state when their background processing is complete. Otherwise,
system performance, "idle-time" system processes such as paging optimizations,
and power management on battery-powered systems will be adversely affected.

While an application is in a PeekMessage() loop, the Windows system cannot go
idle. Therefore, an application should not remain in a PeekMessage() loop after
its background processing has completed.

NOTE: The PeekMessage method described in this article is only needed if your
application is a 32-bit application for Windows and is, for some reason, unable
to create threads and perform background processing.

MORE INFORMATION
================

Many Windows-based applications use PeekMessage() to retrieve messages while
they are in the middle of a long process, such as printing, repaginating, or
recalculating, that must be done "in the background." PeekMessage() is used in
these situations because, unlike GetMessage(), it does not wait for a message to
be placed in the queue before it returns.

An application should not call PeekMessage() unless it has background processing
to do between the calls to PeekMessage(). When an application is waiting for an
input event, it should call GetMessage() or WaitMessage().

Remaining in a PeekMessage() loop when there is no background work causes system
performance problems. A program in a PeekMessage() loop continues to be
rescheduled by the Windows scheduler, consuming CPU time and taking time away
from other processes.

In enhanced mode, the Virtual Machine (VM) in which Windows is running will not
appear to be idle as long as an application is calling the PeekMessage function.
Therefore, the Windows VM will continue to receive a considerable fraction of
CPU time.

Many power management methods employed on laptop and notebook computers are based
on the system going idle when there is no processing to do. An application that
remains in a PeekMessage() loop will make the system appear busy to power
management software, resulting in excessive power consumption and shortening the
time that the user can run the system.

In the future, the Windows system will make more and more use of idle time to do
background processing, which is designed to optimize system performance.
Applications that do not allow the system to go idle will adversely affect the
performance of these techniques.

All these problems can be avoided by calling the PeekMessage() function only when
there is background work to do, and calling GetMessage() or WaitMessage() when
there is no background work to do.

For example, consider the following PeekMessage() loop. If there is no background
processing to do, this loop will continue to run without waiting for messages,
preventing the system from going idle and causing the negative effects described
above.

     // This PeekMessage loop will NOT let the system go idle.

     for( ;; )
     {

        while (PeekMessage(&amp;msg, NULL, 0, 0, PM_REMOVE))
        {
           if (msg.message == WM_QUIT)
              return TRUE;

           TranslateMessage(&amp;msg);
           DispatchMessage(&amp;msg);
        }

        BackgroundProcessing();
      }

This loop can be rewritten in two ways, as shown below. Both of the following
PeekMessage() loops have two desirable properties:

- They process all input messages before performing background processing,
  providing good response to user input.

- The application "idles" (waits for an input message) when no background
  processing needs to be done.

Improved PeekMessage Loop 1
---------------------------

     // Improved PeekMessage() loop

     for(;;)
     {

        while (PeekMessage(&amp;msg, NULL, 0, 0, PM_REMOVE))
        {
           if (msg.message == WM_QUIT)
              return TRUE;

           TranslateMessage(&amp;msg);
           DispatchMessage(&amp;msg);
        }

        if (IfBackgroundProcessingRequired())
           BackgroundProcessing();
        else
           WaitMessage(); // Will not return until a message is posted.

     }

Improved PeekMessage Loop 2
---------------------------

     // Another improved PeekMessage() loop

     for (;;)
     {

        for (;;)
        {
           if (IfBackgroundProcessingRequired())
           {
              if (!PeekMessage(&amp;msg, NULL, 0, 0, PM_REMOVE))
                 break;
           }
           else
              GetMessage(&amp;msg, NULL, 0, 0, 0);

           if (msg.message == WM_QUIT)
              return TRUE;

           TranslateMessage(&amp;msg);
           DispatchMessage(&amp;msg);
        }
        BackgroundProcessing();

     }

Note that calls to functions such as IsDialogMessage() and TranslateAccelerator()
can be added to these loops as appropriate.

There is one case in which the loops above need additional support: if the
application waits for input from a device (for example, a fax board) that does
not send standard Windows messages. For the reasons outlined above, a
Windows-based application should not use a PeekMessage() loop to continuously
poll the device. Rather, implement an Interrupt Service Routine (ISR) in a
Dynamic-Link Library (DLL). When the ISR is called, the DLL can use the
PostMessage function to inform the application that the device requires service.
DLL functions can safely call the PostMessage() function because the
PostMessage() function is reentrant.

Additional query words: 3.00 4.00

======================================================================
Keywords          : kb16bitonly kbSDKPlatform kbWndw kbWndwMsg 
Technology        : kbAudDeveloper kbSDKSearch kbWin32sSearch kbWin32API kbWinSDKSearch
Version           : WINDOWS:3.1,4.0,95; winnt:3.5,3.51
Issue type        : kbhowto

=============================================================================
</code></pre></div></div>


        <p>
            THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
            PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
            ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
            OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
            EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
            ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
            CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
            MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
            POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
            OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
            SO THE FOREGOING LIMITATION MAY NOT APPLY.
        </p>
        <p>Copyright Microsoft Corporation 1986-2002.</p>
    </div>

        </section>

        <footer>
            
            KnowledgeBase Archive is maintained by <a href="https://www.pcjs.org">PCjs</a>.<br>
            
            This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.
        </footer>

    </div>
</div>


<script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-49658648-3', 'auto');
    ga('send', 'pageview');
</script>

</body>
</html>