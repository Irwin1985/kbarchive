<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/kbarchive/assets/css/style.css?v=d2057ae472d963fbdcbf65805f43123bccb709dc">
    <link rel="stylesheet" type="text/css" href="/kbarchive/assets/css/print.css" media="print">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Q70671: Return Must Match Memory Model for CALL to Label in Proc | KnowledgeBase Archive</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Q70671: Return Must Match Memory Model for CALL to Label in Proc" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="An Archive of Early Microsoft KnowledgeBase Articles" />
<meta property="og:description" content="An Archive of Early Microsoft KnowledgeBase Articles" />
<link rel="canonical" href="http://jeffpar.github.io/kbarchive/kb/070/Q70671/" />
<meta property="og:url" content="http://jeffpar.github.io/kbarchive/kb/070/Q70671/" />
<meta property="og:site_name" content="KnowledgeBase Archive" />
<script type="application/ld+json">
{"headline":"Q70671: Return Must Match Memory Model for CALL to Label in Proc","url":"http://jeffpar.github.io/kbarchive/kb/070/Q70671/","description":"An Archive of Early Microsoft KnowledgeBase Articles","@type":"WebPage","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>

<body>
<div id="container">
    <div class="inner">

        <header>
            <h1><a href="/kbarchive">KnowledgeBase Archive</a></h1>
            <h2>An Archive of Early Microsoft KnowledgeBase Articles</h2>
        </header>
        <section id="downloads" class="clearfix">
            
            
            <a href="https://github.com/jeffpar/kbarchive" id="view-on-github" class="button"><span>View on GitHub</span></a>
            
        </section>
        <hr>
        <section id="main_content">
                <div>
        <h2 id="q70671-return-must-match-memory-model-for-call-to-label-in-proc">Q70671: Return Must Match Memory Model for CALL to Label in Proc</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Article: Q70671
Product(s): Microsoft Macro Assembler
Version(s): 5.1,5.1a,6.0,6.0a,6.0b
Operating System(s): 
Keyword(s): 
Last Modified: 06-MAY-2001

-------------------------------------------------------------------------------
The information in this article applies to:

- Microsoft Macro Assembler (MASM), versions 5.1, 5.1a, 6.0, 6.0a, 6.0b 
-------------------------------------------------------------------------------

SUMMARY
=======

With the Macro Assembler (MASM), if a CALL is made to a label within a
procedure, a near call is generated by default. Depending on the memory model
being used, you may need to explicitly specify the correct return.

MORE INFORMATION
================

The standard RET instruction pops off the return address depending on the memory
model. In a small memory model program, the RET instruction is converted to a
RETN, which only pops off the offset to return. In medium and large memory
models, the RET is converted to RETF, which pops off both the segment and offset
to return from the far call. Because a call to a label within a procedure always
results in a near call, the RETF instruction that is generated in medium and
large models will pop a segment value for the return address that was never
pushed.

To ensure that the right size address is popped off the stack relative to that
pushed on the stack, one of the following methods may be used:

1. Use the RET return, but push CS before the call so that the segment and
  offset will both be on the stack for the far return:

        PUSH CS
        CALL label1

- or -

2. Use the FAR PTR override on the call along with a RET to return, so that both
  segment and offset are pushed and popped off the stack:

        CALL FAR PTR label1

- or -

3. Use the LABEL FAR directive along with a RET return so that the assembler
  will generate a far return to match the far label call:

        label1 LABEL FAR

- or -

4. If the label is called ONLY from within the procedure, use RETN explicitly
  (instead of RET) to indicate the NEAR return, so that only the offset is
  popped off the stack:

        label1:
                 RETN

The sample code below demonstrates the need for the proper return for a call to a
label. When assembled and run as is, the code will hang the computer. Adding any
of the solutions described above will correct the code. Comments are included at
the locations where each correction should go.

Sample Code
-----------

  ; Assemble options needed : none

  .MODEL  large

  .STACK

  .CODE

  start:  call proc1

          mov ah, 4ch
          mov al, 0
          int 21h

  proc1   PROC
                         ; #1 - add PUSH CS instruction here
          CALL label1    ; #2 - change call to CALL FAR PTR label1
          RET

  label1:                ; #3 - change label to label1 LABEL FAR
          RET            ; #4 - change return to RETN

  proc1   ENDP

  END start

Additional query words: kbinf 5.10 6.00 6.00a 6.00b

======================================================================
Keywords          :  
Technology        : kbMASMsearch kbAudDeveloper kbMASM510 kbMASM600 kbMASM600a kbMASM510a kbMASM600b
Version           : :5.1,5.1a,6.0,6.0a,6.0b

=============================================================================
</code></pre></div></div>


        <p>
            THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
            PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
            ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
            OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
            EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
            ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
            CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
            MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
            POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
            OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
            SO THE FOREGOING LIMITATION MAY NOT APPLY.
        </p>
        <p>Copyright Microsoft Corporation 1986-2002.</p>
    </div>

        </section>

        <footer>
            
            KnowledgeBase Archive is maintained by <a href="https://www.pcjs.org">PCjs</a>.<br>
            
            This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.
        </footer>

    </div>
</div>


<script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-49658648-3', 'auto');
    ga('send', 'pageview');
</script>

</body>
</html>