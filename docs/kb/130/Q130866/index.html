<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/kbarchive/assets/css/style.css?v=d2057ae472d963fbdcbf65805f43123bccb709dc">
    <link rel="stylesheet" type="text/css" href="/kbarchive/assets/css/print.css" media="print">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Q130866: INFO: Using a TimerProc Function in MFC Application | KnowledgeBase Archive</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Q130866: INFO: Using a TimerProc Function in MFC Application" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="An Archive of Early Microsoft KnowledgeBase Articles" />
<meta property="og:description" content="An Archive of Early Microsoft KnowledgeBase Articles" />
<link rel="canonical" href="http://jeffpar.github.io/kbarchive/kb/130/Q130866/" />
<meta property="og:url" content="http://jeffpar.github.io/kbarchive/kb/130/Q130866/" />
<meta property="og:site_name" content="KnowledgeBase Archive" />
<script type="application/ld+json">
{"headline":"Q130866: INFO: Using a TimerProc Function in MFC Application","url":"http://jeffpar.github.io/kbarchive/kb/130/Q130866/","description":"An Archive of Early Microsoft KnowledgeBase Articles","@type":"WebPage","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>

<body>
<div id="container">
    <div class="inner">

        <header>
            <h1><a href="/kbarchive">KnowledgeBase Archive</a></h1>
            <h2>An Archive of Early Microsoft KnowledgeBase Articles</h2>
        </header>
        <section id="downloads" class="clearfix">
            
            
            <a href="https://github.com/jeffpar/kbarchive" id="view-on-github" class="button"><span>View on GitHub</span></a>
            
        </section>
        <hr>
        <section id="main_content">
                <div>
        <h2 id="q130866-info-using-a-timerproc-function-in-mfc-application">Q130866: INFO: Using a TimerProc Function in MFC Application</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Article: Q130866
Product(s): Microsoft C Compiler
Version(s): 1.0,1.5,1.51,1.52,2.0,2.1,4.0
Operating System(s): 
Keyword(s): kbfile kbSample kbMFC kbVC100 kbVC150 kbVC200 kbGrpDSMFCATL
Last Modified: 21-DEC-2001

-------------------------------------------------------------------------------
The information in this article applies to:

- The Microsoft Foundation Classes (MFC), used with:
   - Microsoft Visual C++ for Windows, 16-bit edition, versions 1.0, 1.5, 1.51, 1.52 
   - Microsoft Visual C++, 32-bit Editions, versions 1.0, 2.0, 2.1, 4.0 
-------------------------------------------------------------------------------

SUMMARY
=======

The TMRPROC sample is designed to demonstrate how to use the SetTimer() API in
an MFC Application in such a way that the TimerProc() callback function (a
member of a C++ class) is used instead of handling WM_TIMER messages. There are
two makefiles included:

- TMRPROC.MAK, generated by Visual C++ version 1.5.

- TMRPRC32.MAK, generated by Visual C++ version 2.0.

MORE INFORMATION
================

The following file is available for download from the Microsoft Download
Center:

  Tmrproc.exe
  (http://download.microsoft.com/download/vc15/Sample/3/WIN98/EN-US/tmrproc.exe)

For additional information about how to download Microsoft Support files, click
the article number below to view the article in the Microsoft Knowledge Base:

  Q119591 How to Obtain Microsoft Support Files from Online Services

Microsoft used the most current virus detection software available on the date of
posting to scan this file for viruses. Once posted, the file is housed on secure
servers that prevent any unauthorized changes to the file.



NOTE: When extracting files from TMRPROC.EXE, be sure to use the -d option to
create subdirectories.

The challenge of using callback functions as C++ class members can be approached
in several different ways, depending on the circumstances surrounding the
callback. In "Calling All Members:..." (see References below), four different
approaches are mentioned. They are:

- Not accessing any class members from within the static callback.

- Storing the "this" pointer to the object in a static member.

- Passing the "this" pointer to the callback function via a parameter supplied
  by APIs that use callbacks.

- Storing a list of "this" pointers mapped to the list of objects servicing the
  callback in a static structure.

The TMRPROC sample application illustrates the second and fourth cases. These are
the most likely scenarios MFC Doc/View/UI type applications encounter. Not
accessing any members from a callback is quite limiting, and passing the "this"
pointer in a callback-supplied parameter is dependent on the API. For these
reasons, the sample does not address the first and third cases.

TMRPROC.CPP and .H
------------------

Storing the "this" pointer to the object in a static member is demonstrated in
the CWinApp-derived class, CTmrprocApp.

There is no window associated with this class, so the output used to indicate the
timer event is done via OutputDebugString(). The pThis variable is a static
member variable that is initialized in the constructor to contain the "this"
pointer for the class. The TimerProc() callback is simply a static member
function of type "void CALLBACK EXPORT." It is static, so no "this" pointer is
passed in. For this reason, the pThis member variable is used to store the
CTmrprocApp's "this" pointer. Whenever TimerProc() gets called, the current
instance of CTmrprocApp can be referenced through the CTmrprocApp::pThis
member.

This is the simplest case. There are three functions added to the CTmrprocApp
class to accomplish this objective - TimerProc(), CTmrprocApp::OnAppsettimer(),
and CTmrprocApp::OnAppkilltimer(). The later two are the menu handlers that
allow the user to start and stop the timer.

TMRPRVW.CPP and .H
------------------

Storing a list of "this" pointers mapped to the list of objects servicing the
callback in a static structure is implemented in the view class, CTmrprocView.

In this case, a little more work is required, but not much. Because a timer needs
to be set for each instance of the view class, a scheme must be implemented to
associate each timer ID with a corresponding view object. The view object is
identified by its "this" pointer and the timer by its timer ID (passed back from
SetTimer()). The view class associates these and stores them in a CMapWordToPtr
static member variable. This way, when each view's TimerProc() is called, it can
first look up its "this" pointer in the pointer/ID map, and then update its own
members.

There are several functions needed to start, stop, and reset the count on the
timer. The count is just a running count of the number of times TimerProc() has
been called for the current view. The following are the start, stop, and reset
functions:

  CTmrprocView::OnTimerStart()    - Start timer in current view.
  CTmrprocView::OnTimerStop()     - Stop timer in current view.
  CTmrprocView::OnTimerReset()    - Reset count for current view.

The following are some "all" type functions that can be used to start, stop, and
reset the timer for each view:

  CTmrprocView::OnTimerAllStart() - Start timers for all views.
  CTmrprocView::OnTimerAllStop()  - Stop timers for all views.
  CTmrprocView::OnTimerAllReset() - Reset timer count for all views.

REFERENCES
==========

MSDN Technical Articles, C/C++ Articles, "Calling All Members: Member Functions
As Callbacks," by Dale Rogerson.

Additional query words: kbfile tmrproc settimer

======================================================================
Keywords          : kbfile kbSample kbMFC kbVC100 kbVC150 kbVC200 kbGrpDSMFCATL 
Technology        : kbAudDeveloper kbMFC
Version           : :1.0,1.5,1.51,1.52,2.0,2.1,4.0
Issue type        : kbhowto

=============================================================================
</code></pre></div></div>


        <p>
            THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
            PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
            ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
            OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
            EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
            ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
            CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
            MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
            POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
            OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
            SO THE FOREGOING LIMITATION MAY NOT APPLY.
        </p>
        <p>Copyright Microsoft Corporation 1986-2002.</p>
    </div>

        </section>

        <footer>
            
            KnowledgeBase Archive is maintained by <a href="https://www.pcjs.org">PCjs</a>.<br>
            
            This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.
        </footer>

    </div>
</div>


<script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-49658648-3', 'auto');
    ga('send', 'pageview');
</script>

</body>
</html>